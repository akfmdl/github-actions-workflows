apiVersion: apps/v1
kind: Deployment
metadata:
  name: perso-vt-audio-engine-stg
  namespace: perso-vt-audio
  labels:
    app: perso-vt-audio-engine-stg
spec:
  replicas: 1
  revisionHistoryLimit: 1
  selector:
    matchLabels:
      app: perso-vt-audio-engine-stg
  template:
    metadata:
      labels:
        app: perso-vt-audio-engine-stg
    spec:
      containers:
        - name: perso-vt-audio-engine-stg
          image: persolive.azurecr.io/audio-engine-server:1.0.0
          imagePullPolicy: Always
          ports:
            - containerPort: 80
---
apiVersion: batch/v1
kind: Job
metadata:
  name: notify-deployment-complete
  namespace: perso-vt-audio
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  # Job ì™„ë£Œ í›„ 300ì´ˆ(5ë¶„) ë’¤ ìë™ ì‚­ì œ
  ttlSecondsAfterFinished: 300
  # ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ íšŸìˆ˜ ì œí•œ
  backoffLimit: 2
  # ìµœëŒ€ ì‹¤í–‰ ì‹œê°„ (10ë¶„)
  activeDeadlineSeconds: 600
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: teams-notification
        image: curlimages/curl:latest
        env:
        - name: FULL_IMAGE
          value: persolive.azurecr.io/audio-engine-server:2025.06.0.5
        - name: REPO_INFO
          value: est-infra/persolive-admin-aks-stg
        - name: TARGET_BRANCH
          value: main
        - name: UPDATED_FILE
          value: stg-idc/02-perso-vt/01-perso-vt-audio/01-perso-vt-audio-engine/perso-vt-audio-engine-stg.yaml
        - name: TEAMS_WORKFLOW_URL
          value: https://prod-29.koreacentral.logic.azure.com:443/workflows/349eefc58f9c41f8bd88fb5252bfe9c1/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=YtUh3bh4RnGEUfzixwCFNlYHefFxe4y15LLUO2QrKII
        command:
        - /bin/sh
        - -c
        - |
          echo "ğŸ“¢ Teams ë°°í¬ ì™„ë£Œ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤..."
          
          # Teams Workflow URL í™•ì¸
          if [ -z "$TEAMS_WORKFLOW_URL" ]; then
            echo "âš ï¸ TEAMS_Workflow_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Teams ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi

          
          # Teams ë©”ì‹œì§€ JSON ìƒì„±
          cat > /tmp/teams_message.json << EOF
          {
              "type": "message",
              "attachments": [
                  {
                      "contentType": "application/vnd.microsoft.card.adaptive",
                      "content": {
                          "$schema": "http://adaptivecards.json/schema/adaptive-card/1.5",
                          "type": "AdaptiveCard",
                          "msteams": {
                              "entities": [
                                  {
                                      "type": "mention",
                                      "text": "<at>ì˜¤ë””ì˜¤ì—”ì§„</at>",
                                      "mentioned": {
                                          "id": "ZjdkZDQ4MmItYzU4ZC00MDViLVFlNjAtNTlmNmFjMzZmZWVmIyNjMDQzMWZmOC0zZTBkLTQ0ZjgtYmFlZS05YWFjMDQ1Nzk1NjMjI3RLUUEyYWI5RnQ=",
                                          "name": "ì˜¤ë””ì˜¤ì—”ì§„",
                                          "type": "tag"
                                      }
                                  }
                              ]
                          },
                          "body": [
                              {
                                  "type": "TextBlock",
                                  "text": "âœ… Stage ë°°í¬ ì™„ë£Œ",
                                  "size": "Large",
                                  "weight": "Bolder"
                              },
                              {
                                  "type": "TextBlock",
                                  "text": "<at>ì˜¤ë””ì˜¤ì—”ì§„</at>",
                                  "wrap": true
                              },
                              {
                                  "type": "TextBlock",
                                  "text": "Stage ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
                                  "wrap": true
                              },
                              {
                                  "type": "FactSet",
                                  "facts": [
                                      {
                                          "title": "ì „ì²´ ì´ë¯¸ì§€ëª…: ",
                                          "value": "${FULL_IMAGE}"
                                      },
                                      {
                                          "title": "ëŒ€ìƒ ë ˆí¬ì§€í† ë¦¬: ",
                                          "value": "${REPO_INFO}"
                                      },
                                      {
                                          "title": "ëŒ€ìƒ ë¸Œëœì¹˜:",
                                          "value": "${TARGET_BRANCH:-main}"
                                      },
                                      {
                                          "title": "ì—…ë°ì´íŠ¸ëœ íŒŒì¼:",
                                          "value": "${UPDATED_FILE:-ì•Œ ìˆ˜ ì—†ìŒ}"
                                      }
                                  ]
                              }
                          ]
                      }
                  }
              ]
          }
          EOF
          
          echo "ğŸ“‹ Teams ë©”ì‹œì§€ ë‚´ìš©:"
          cat /tmp/teams_message.json
          
          # Teams Workflowë¡œ ë©”ì‹œì§€ ì „ì†¡
          response=$(curl -w "%{http_code}" -s -X POST \
            -H "Content-Type: application/json" \
            -d @/tmp/teams_message.json \
            "$TEAMS_WORKFLOW_URL")
          
          # /bin/sh í˜¸í™˜ ë¬¸ë²•ìœ¼ë¡œ ì‘ë‹µ ì½”ë“œ ì¶”ì¶œ
          http_code=$(echo "$response" | tail -c 4)
          response_body=$(echo "$response" | head -c -4)
          
          echo ""
          echo "HTTP ì‘ë‹µ ì½”ë“œ: $http_code"
          if [ "$response_body" != "" ]; then
            echo "ì‘ë‹µ ë‚´ìš©: $response_body"
          fi
          
          if [ "$http_code" -ge "400" ]; then
            echo "âŒ Teams ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨ (HTTP $http_code)"
            exit 1
          else
            echo "âœ… Teams ë°°í¬ ì™„ë£Œ ì•Œë¦¼ ì „ì†¡ ì„±ê³µ"
          fi
          
          echo "ğŸ‰ ë°°í¬ ì™„ë£Œ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ"
