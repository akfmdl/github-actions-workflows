name: Docker Build, Push and Update Repository

on:
  push:
    branches:
      - test

env:
  DOCKER_REGISTRY: persolive.azurecr.io
  IMAGE_NAME: audio-engine-server
  TARGET_REPO: akfmdl/github-actions-workflows
  TARGET_BRANCH: test
  TARGET_FILE_PATH: values.yaml
  IMAGE_TAG: 1.0.0

jobs:
  docker-build-and-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Auto Release
      id: auto-release
      uses: akfmdl/github-actions-workflows/actions/auto-release-custom-versioning@test
      with:
        github-token: ${{ secrets.GIT_TOKEN }}
        release-branches: '["test"]'
        jira-base-url: ${{ secrets.JIRA_BASE_URL }}

    - name: Prepare Teams message templates
      id: prepare-teams-messages
      run: |
        # Teams ì‹œì‘ ë©”ì‹œì§€ ì¤€ë¹„
        if [ -f "scripts/teams_message_start.json" ]; then
          echo "ğŸ“‹ Teams ì‹œì‘ ë©”ì‹œì§€ í…œí”Œë¦¿ ì½ëŠ” ì¤‘..."
          
          # ë³€ìˆ˜ ì •ì˜
          IMAGE_INFO="${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          REPO_INFO="${{ env.TARGET_REPO }}"
          
          # Pythonìœ¼ë¡œ Teams JSON í…œí”Œë¦¿ ì²˜ë¦¬ (ì•ˆì „í•œ JSON ìƒì„±)
          echo "ğŸ Pythonìœ¼ë¡œ Teams JSON ì²˜ë¦¬ ì¤‘..."
          
          # Python ìŠ¤í¬ë¦½íŠ¸ë¡œ Teams JSON ìƒì„± (argparse ë°©ì‹)
          if [ -f "scripts/teams_message_start.json" ]; then
            TEAMS_START_JSON=$(python3 scripts/process_teams_template.py \
              scripts/teams_message_start.json \
              --image-info "${IMAGE_INFO}" \
              --repo-info "${REPO_INFO}"
            echo "ğŸ“ Pythonìœ¼ë¡œ Teams JSON ìƒì„± ì™„ë£Œ"
          else
            echo "âš ï¸ Teams í…œí”Œë¦¿ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: scripts/teams_message_start.json"
            TEAMS_START_JSON='{"type": "message", "text": "Teams í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}'
          fi
          
          # ë©€í‹°ë¼ì¸ ì¶œë ¥ ì²˜ë¦¬
          echo "TEAMS_START_JSON<<EOF" >> $GITHUB_OUTPUT
          echo "$TEAMS_START_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "âœ… Teams ì‹œì‘ ë©”ì‹œì§€ ì¤€ë¹„ ì™„ë£Œ"
        else
          echo "TEAMS_START_JSON=" >> $GITHUB_OUTPUT
          echo "âš ï¸ Teams ì‹œì‘ ë©”ì‹œì§€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
        fi

    - name: Send Teams notification - Start
      if: steps.prepare-teams-messages.outputs.TEAMS_START_JSON != ''
      shell: bash
      run: |
        if [ -z "${{ secrets.TEAMS_WORKFLOWS_URL }}" ]; then
          echo "âš ï¸ TEAMS_WORKFLOWS_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Teams ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          exit 0
        fi
        
        echo "ğŸ“¢ Teams ì•Œë¦¼ ì „ì†¡ ì¤‘: ë°°í¬ ì‹œì‘"
        
        # ì‚¬ìš©ì ì œê³µ JSONì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        echo '${{ steps.prepare-teams-messages.outputs.TEAMS_START_JSON }}' > teams_message_start.json
        
        # Teams Webhookìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
        curl -H "Content-Type: application/json" \
             -d @teams_message_start.json \
             "${{ secrets.TEAMS_WORKFLOWS_URL }}"
        
        echo "âœ… Teams ë°°í¬ ì‹œì‘ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ"

    - name: Docker Build, Push and Update Repository
      id: docker-build-update
      uses: akfmdl/github-actions-workflows/actions/docker-build-and-update@test
      with:
        docker-registry: ${{ env.DOCKER_REGISTRY }}
        github-token: ${{ secrets.GIT_TOKEN }}
        image-name: ${{ env.IMAGE_NAME }}
        image-tag: ${{ env.IMAGE_TAG }}
        dockerfile-path: Dockerfile
        build-context: .
        build-args: |
          GIT_TOKEN=${{ secrets.GIT_TOKEN }}
        registry-username: ${{ secrets.REGISTRY_USERNAME }}
        registry-password: ${{ secrets.REGISTRY_PASSWORD }}
        target-repo: ${{ env.TARGET_REPO }}
        target-file-path: ${{ env.TARGET_FILE_PATH }}
        target-branch: ${{ env.TARGET_BRANCH }}
        
    # - name: Send Teams notification - Complete
    #   if: steps.prepare-teams-messages.outputs.TEAMS_COMPLETE_JSON != ''
    #   shell: bash
    #   run: |
    #     if [ -z "${{ secrets.TEAMS_WORKFLOWS_URL }}" ]; then
    #       echo "âš ï¸ TEAMS_WORKFLOWS_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Teams ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
    #       exit 0
    #     fi
        
    #     echo "ğŸ“¢ Teams ì•Œë¦¼ ì „ì†¡ ì¤‘: ë°°í¬ ì™„ë£Œ"
        
    #     # ì‚¬ìš©ì ì œê³µ JSONì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    #     echo '${{ steps.prepare-teams-messages.outputs.TEAMS_COMPLETE_JSON }}' > teams_message_complete.json
        
    #     # Teams Webhookìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
    #     curl -H "Content-Type: application/json" \
    #          -d @teams_message_complete.json \
    #          "${{ secrets.TEAMS_WORKFLOWS_URL }}"
        
    #     echo "âœ… Teams ë°°í¬ ì™„ë£Œ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ"

    - name: Post-deployment notification
      if: steps.docker-build-update.outputs.updated-file != ''
      run: |
        echo "ğŸ‰ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ë°°í¬ ì™„ë£Œ!"
        echo "Docker Image: ${{ steps.docker-build-update.outputs.full-image-name }}"
        echo "Updated File: ${{ steps.docker-build-update.outputs.updated-file }}"
        echo "Commit Message: ${{ steps.docker-build-update.outputs.commit-message }}"