name: Docker Build, Push and Update Repository

on:
  push:
    branches:
      - test

env:
  DOCKER_REGISTRY: persolive.azurecr.io
  IMAGE_NAME: audio-engine-server
  TARGET_REPO: akfmdl/mlops-lifecycle
  TARGET_BRANCH: test
  TARGET_FILE_PATH: stg-idc/02-perso-vt/01-perso-vt-audio/01-perso-vt-audio-engine/perso-vt-audio-engine-stg.yaml

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Auto Release
      id: auto-release
      uses: akfmdl/github-actions-workflows/actions/auto-release-custom-versioning@test
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        release-branches: '["test"]'
        jira-base-url: https://estsoft.atlassian.net

    - name: Prepare Teams message templates
      if: steps.auto-release.outputs.new-release-published == 'true'
      id: prepare-teams-messages
      run: |
        # Teams ì‹œì‘ ë©”ì‹œì§€ ì¤€ë¹„
        if [ -f "scripts/teams_message_start.json" ]; then
          echo "ğŸ“‹ Teams ì‹œì‘ ë©”ì‹œì§€ í…œí”Œë¦¿ ì½ëŠ” ì¤‘..."
          
          # ë³€ìˆ˜ ì •ì˜
          IMAGE_INFO="${{ env.IMAGE_NAME }}:${{ steps.auto-release.outputs.new-release-version }}"
          REPO_INFO="${{ env.TARGET_REPO }}"
          
          # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ íŒŒì¼ ì½ê¸°
          if [ -f "${{ env.RELEASE_NOTES_FILE }}" ]; then
            # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ë¥¼ JSON ë¬¸ìì—´ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
            RELEASE_NOTES=$(cat "${{ env.RELEASE_NOTES_FILE }}" | \
              sed 's/^## \(.*\)/**\1**/g' | \
              sed 's/\\/\\\\/g' | \
              sed 's/"/\\"/g' | \
              tr -d '\r\t' | \
              sed '/^$/N;/^\n$/d' | \
              sed 's/$/\\n\\n/g' | \
              tr -d '\n' | \
              sed 's/\\n\\n$//')
            echo "ğŸ“ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ íŒŒì¼ ì½ê¸° ì™„ë£Œ: ${{ env.RELEASE_NOTES_FILE }}"
            echo "ğŸ“ ì²˜ë¦¬ëœ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ê¸¸ì´: ${#RELEASE_NOTES} ë¬¸ì"
          else
            RELEASE_NOTES="ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "âš ï¸ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${{ env.RELEASE_NOTES_FILE }}"
          fi
          
          # JSON íŒŒì¼ ì½ê¸° ë° ë³€ìˆ˜ ì¹˜í™˜
          TEAMS_START_JSON=$(cat scripts/teams_message_start.json | \
            sed "s|\${IMAGE_INFO}|${IMAGE_INFO}|g" | \
            sed "s|\${REPO_INFO}|${REPO_INFO}|g" | \
            sed "s|\${RELEASE_NOTES}|${RELEASE_NOTES}|g")
          
          # ë©€í‹°ë¼ì¸ ì¶œë ¥ ì²˜ë¦¬
          echo "TEAMS_START_JSON<<EOF" >> $GITHUB_OUTPUT
          echo "$TEAMS_START_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "âœ… Teams ì‹œì‘ ë©”ì‹œì§€ ì¤€ë¹„ ì™„ë£Œ"
        else
          echo "TEAMS_START_JSON=" >> $GITHUB_OUTPUT
          echo "âš ï¸ Teams ì‹œì‘ ë©”ì‹œì§€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
        fi
        
        # Teams ì™„ë£Œ ë©”ì‹œì§€ ì¤€ë¹„
        if [ -f "scripts/teams_message_complete.json" ]; then
          echo "ğŸ“‹ Teams ì™„ë£Œ ë©”ì‹œì§€ í…œí”Œë¦¿ ì½ëŠ” ì¤‘..."
          
          # ë³€ìˆ˜ ì •ì˜
          IMAGE_INFO="${{ env.IMAGE_NAME }}:${{ steps.auto-release.outputs.new-release-version }}"
          REPO_INFO="${{ env.TARGET_REPO }}"
          FULL_IMAGE="${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.auto-release.outputs.new-release-version }}"
          TARGET_BRANCH="${{ env.TARGET_BRANCH }}"
          UPDATED_FILE="${{ env.TARGET_FILE_PATH }}"
          GITHUB_REPOSITORY="${{ github.repository }}"
          GITHUB_RUN_ID="${{ github.run_id }}"
          
          # ì„±ê³µ ì‹œ ë©”ì‹œì§€ (ê¸°ë³¸ê°’)
          ACTIVITY_TITLE="âœ… Stage ë°°í¬ ì™„ë£Œ"
          STATUS_MESSAGE="Stage ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
          
          # JSON íŒŒì¼ ì½ê¸° ë° ë³€ìˆ˜ ì¹˜í™˜
          TEAMS_COMPLETE_JSON=$(cat scripts/teams_message_complete.json | \
            sed "s|\${IMAGE_INFO}|${IMAGE_INFO}|g" | \
            sed "s|\${REPO_INFO}|${REPO_INFO}|g" | \
            sed "s|\${FULL_IMAGE}|${FULL_IMAGE}|g" | \
            sed "s|\${TARGET_BRANCH:-default}|${TARGET_BRANCH}|g" | \
            sed "s|\${UPDATED_FILE:-ì—†ìŒ}|${UPDATED_FILE}|g" | \
            sed "s|\${ACTIVITY_TITLE}|${ACTIVITY_TITLE}|g" | \
            sed "s|\${STATUS_MESSAGE}|${STATUS_MESSAGE}|g" | \
            sed "s|\${GITHUB_REPOSITORY}|${GITHUB_REPOSITORY}|g" | \
            sed "s|\${GITHUB_RUN_ID}|${GITHUB_RUN_ID}|g")
          
          # ë©€í‹°ë¼ì¸ ì¶œë ¥ ì²˜ë¦¬
          echo "TEAMS_COMPLETE_JSON<<EOF" >> $GITHUB_OUTPUT
          echo "$TEAMS_COMPLETE_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "âœ… Teams ì™„ë£Œ ë©”ì‹œì§€ ì¤€ë¹„ ì™„ë£Œ"
        else
          echo "TEAMS_COMPLETE_JSON=" >> $GITHUB_OUTPUT
          echo "âš ï¸ Teams ì™„ë£Œ ë©”ì‹œì§€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
        fi

    - name: Post-release notification
      if: steps.auto-release.outputs.new-release-published == 'true'
      run: |
        echo "ğŸ‰ ìƒˆë¡œìš´ ë¦´ë¦¬ì¦ˆê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ë²„ì „: ${{ steps.auto-release.outputs.new-release-version }}"
        echo "íƒœê·¸: ${{ steps.auto-release.outputs.new-release-git-tag }}"
        echo "SHA: ${{ steps.auto-release.outputs.new-release-git-head }}" 

    - name: Docker Build, Push and Update Repository
      id: docker-build-update
      if: steps.auto-release.outputs.new-release-published == 'true'
      uses: akfmdl/github-actions-workflows/actions/docker-build-and-update@test
      with:
        docker-registry: ${{ env.DOCKER_REGISTRY }}
        github-token: ${{ secrets.GIT_TOKEN }}
        image-name: ${{ env.IMAGE_NAME }}
        image-tag: ${{ steps.auto-release.outputs.new-release-version }}
        dockerfile-path: Dockerfile
        build-context: .
        build-args: |
          GIT_TOKEN=${{ secrets.GIT_TOKEN }}
        registry-username: ${{ secrets.REGISTRY_USERNAME }}
        registry-password: ${{ secrets.REGISTRY_PASSWORD }}
        target-repo: ${{ env.TARGET_REPO }}
        target-file-path: ${{ env.TARGET_FILE_PATH }}
        target-branch: ${{ env.TARGET_BRANCH }}
        teams-workflow-url: https://prod-29.koreacentral.logic.azure.com:443/workflows/349eefc58f9c41f8bd88fb5252bfe9c1/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=YtUh3bh4RnGEUfzixwCFNlYHefFxe4y15LLUO2QrKII
        teams-message-start-json: ${{ steps.prepare-teams-messages.outputs.TEAMS_START_JSON }}
        teams-message-complete-json: ${{ steps.prepare-teams-messages.outputs.TEAMS_COMPLETE_JSON }}

    - name: Post-deployment notification
      if: steps.docker-build-update.outputs.updated-file != ''
      run: |
        echo "ğŸ‰ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ë°°í¬ ì™„ë£Œ!"
        echo "Docker Image: ${{ steps.docker-build-update.outputs.full-image-name }}"
        echo "Updated File: ${{ steps.docker-build-update.outputs.updated-file }}"
        echo "Commit Message: ${{ steps.docker-build-update.outputs.commit-message }}"