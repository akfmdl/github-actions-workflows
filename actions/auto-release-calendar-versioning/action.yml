name: 'Auto Release with Calendar Versioning'
description: 'Automatically create GitHub releases using semantic-release when pushing to specified branches with calendar versioning'
author: 'GitHub Actions Workflows'

inputs:
  github-token:
    description: 'GitHub token for authentication'
    required: true
  node-version:
    description: 'Node.js version to use'
    required: false
    default: '18'
  release-branches:
    description: 'Branches to release from (JSON array format)'
    required: false
    default: '["main", "master"]'
  dry-run:
    description: 'Whether to run in dry-run mode'
    required: false
    default: 'false'
  working-directory:
    description: 'Working directory for the action'
    required: false
    default: '.'
  semantic-release-version:
    description: 'Semantic Release version to use'
    required: false
    default: '22'

outputs:
  new-release-published:
    description: 'Whether a new release was published'
    value: ${{ steps.semantic-release.outputs.new-release-published }}
  new-release-version:
    description: 'Version of the new release'
    value: ${{ steps.semantic-release.outputs.new-release-version }}
  new-release-git-tag:
    description: 'Git tag of the new release'
    value: ${{ steps.semantic-release.outputs.new-release-git-tag }}
  new-release-git-head:
    description: 'Git SHA of the new release'
    value: ${{ steps.semantic-release.outputs.new-release-git-head }}

runs:
  using: 'composite'
  steps:
    - name: Checkout ì½”ë“œ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ inputs.github-token }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}

    - name: Install local dependencies (if package.json exists)
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        if [ -f "package.json" ]; then
          echo "ğŸ“¦ Installing project dependencies..."
          if [ -f "package-lock.json" ]; then
            npm ci
          elif [ -f "yarn.lock" ]; then
            yarn install --frozen-lockfile
          elif [ -f "pnpm-lock.yaml" ]; then
            npm install -g pnpm
            pnpm install --frozen-lockfile
          else
            npm install
          fi
        else
          echo "âš ï¸ No package.json found"
          exit 1
        fi

    - name: Set execution permission for scripts
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        chmod +x scripts/generate-version.js
        chmod +x scripts/calendar-version-plugin.js
        chmod +x scripts/calendar-version-wrapper.js

    - name: Run semantic-release with calendar versioning
      id: semantic-release
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
        GIT_AUTHOR_NAME: github-actions[bot]
        GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
        GIT_COMMITTER_NAME: github-actions[bot]
        GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
      run: |
        # JSON ë°°ì—´ì„ ê³µë°±ìœ¼ë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ë¡œ ë³€í™˜
        BRANCHES=$(echo '${{ inputs.release-branches }}' | jq -r '.[]' | paste -sd ' ')
        
        if [ "${{ inputs.dry_run }}" = "true" ]; then
          echo "ğŸš€ Running semantic-release@${{ inputs.semantic-release-version }} in dry-run mode..."
          echo "ğŸ“… Calendar Versioning í˜•ì‹: year.month.minor.fix"
          npx semantic-release@${{ inputs.semantic-release-version }} --dry-run --branches $BRANCHES
        else
          echo "ğŸš€ Running semantic-release@${{ inputs.semantic-release-version }}..."
          echo "ğŸ“… Calendar Versioning í˜•ì‹: year.month.minor.fix"
          npx semantic-release@${{ inputs.semantic-release-version }} --branches $BRANCHES
        fi

    - name: Override Git tag with calendar version
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
      run: |
        if [ "${{ inputs.dry_run }}" != "true" ] && [ -n "$CALENDAR_VERSION" ]; then
          echo "ğŸ·ï¸ Creating calendar version tag: v$CALENDAR_VERSION"
          
          # ê¸°ì¡´ semantic release íƒœê·¸ ì‚­ì œ (ë¡œì»¬ ë° ì›ê²©)
          SEMANTIC_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [[ "$SEMANTIC_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ğŸ—‘ï¸ Removing semantic version tag: $SEMANTIC_TAG"
            git tag -d "$SEMANTIC_TAG" || true
            git push origin ":refs/tags/$SEMANTIC_TAG" || true
          fi
          
          # Calendar version íƒœê·¸ ìƒì„±
          git tag "v$CALENDAR_VERSION"
          git push origin "v$CALENDAR_VERSION"
          
          echo "âœ… Calendar version tag created: v$CALENDAR_VERSION"
          
          # GitHub CLI ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
          if ! command -v gh &> /dev/null; then
            echo "ğŸ“¥ Installing GitHub CLI..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh -y
          fi
          
          # GitHub release ì—…ë°ì´íŠ¸
          echo "ğŸ“ Updating GitHub release to calendar version..."
          
          # ê¸°ì¡´ semantic version release ì‚­ì œ
          if [[ -n "$SEMANTIC_TAG" ]]; then
            gh release delete "$SEMANTIC_TAG" --yes || true
          fi
          
          # Calendar versionìœ¼ë¡œ ìƒˆ release ìƒì„±
          RELEASE_NOTES=$(gh api repos/:owner/:repo/releases/latest --jq '.body' 2>/dev/null || echo "Calendar Versioning Release")
          gh release create "v$CALENDAR_VERSION" \
            --title "v$CALENDAR_VERSION" \
            --notes "$RELEASE_NOTES" \
            --latest
          
          echo "âœ… GitHub release created: v$CALENDAR_VERSION"
          
          # PR ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸ (ê°€ì¥ ìµœê·¼ merged PR ì°¾ê¸°)
          echo "ğŸ’¬ Updating PR comments with calendar version..."
          
          # ìµœê·¼ mergeëœ PRë“¤ ì°¾ê¸°
          RECENT_PRS=$(gh pr list --state merged --limit 10 --json number,mergedAt --jq '.[] | select(.mergedAt != null) | .number')
          
          for PR_NUMBER in $RECENT_PRS; do
            # semantic version ì½”ë©˜íŠ¸ ì°¾ê¸°
            COMMENT_ID=$(gh api repos/:owner/:repo/issues/$PR_NUMBER/comments --jq '.[] | select(.user.login == "github-actions[bot]" and (.body | contains("ğŸ‰ This PR is included in version"))) | .id' | head -n1)
            
            if [ -n "$COMMENT_ID" ]; then
              # ê¸°ì¡´ ì½”ë©˜íŠ¸ ì‚­ì œ
              gh api repos/:owner/:repo/issues/comments/$COMMENT_ID -X DELETE || true
              
              # ìƒˆ calendar version ì½”ë©˜íŠ¸ ì¶”ê°€
              gh pr comment $PR_NUMBER --body "ğŸ‰ This PR is included in version $CALENDAR_VERSION ğŸ‰

The release is available on:

ğŸ“… [v$CALENDAR_VERSION](https://github.com/\${{ github.repository }}/releases/tag/v$CALENDAR_VERSION)
ğŸ“‹ GitHub release

Your semantic-release bot ğŸ“¦ğŸš€ (Calendar Versioning)"
              
              echo "âœ… Updated PR #$PR_NUMBER comment with calendar version"
              break
            fi
          done
          
        fi

branding:
  icon: 'calendar'
  color: 'purple' 