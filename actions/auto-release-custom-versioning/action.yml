name: 'Auto Release with Custom Versioning'
description: 'Automatically create GitHub releases using semantic-release when pushing to specified branches with custom versioning'
author: 'GitHub Actions Workflows'

inputs:
  github-token:
    description: 'GitHub token for authentication'
    required: true
  ssh-key:
    description: 'SSH key for authentication'
    required: false
    default: ''
  node-version:
    description: 'Node.js version to use'
    required: false
    default: '18'
  release-branches:
    description: 'Branches to release from (JSON array format)'
    required: false
    default: '["main", "master"]'
  working-directory:
    description: 'Working directory for the action'
    required: false
    default: '.'
  jira-base-url:
    description: 'Jira base URL'
    required: false
    default: 'https://your-jira-instance.atlassian.net'
  version-py-path:
    description: 'Path to version.py file (relative to working directory)'
    required: false
    default: ''
  version-prefix:
    description: 'Prefix for version numbers (e.g., "v" for v1.0.0)'
    required: false
    default: ''
  default-release-type:
    description: 'Default release type when no PR labels are found (patch or minor)'
    required: false
    default: 'patch'
  patch-version-prefix:
    description: 'Prefix for patch version numbers (e.g., "rc", "alpha", "beta", "post")'
    required: false
    default: ''
  include-patch-for-minor:
    description: 'Include patch version for minor releases (true/false)'
    required: false
    default: 'true'

outputs:
  new-release-published:
    description: 'Whether a new release was published'
    value: ${{ steps.custom-versioning.outputs.new-release-published }}
  new-release-version:
    description: 'Version of the new release'
    value: ${{ steps.custom-versioning.outputs.new-release-version }}
  new-release-git-tag:
    description: 'Git tag of the new release'
    value: ${{ steps.custom-versioning.outputs.new-release-git-tag }}
  new-release-git-head:
    description: 'Git SHA of the new release'
    value: ${{ steps.custom-versioning.outputs.new-release-git-head }}

runs:
  using: 'composite'
  steps:
    - name: Checkout ì½”ë“œ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ssh-key: ${{ inputs.ssh-key }}
        token: ${{ inputs.github-token }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}

    - name: Install dependencies
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        if [ -f "package.json" ]; then
          echo "ğŸ“¦ Installing project dependencies..."
          if [ -f "package-lock.json" ]; then
            npm ci
          elif [ -f "yarn.lock" ]; then
            yarn install --frozen-lockfile
          elif [ -f "pnpm-lock.yaml" ]; then
            npm install -g pnpm
            pnpm install --frozen-lockfile
          else
            npm install
          fi
        else
          echo "âš ï¸ No package.json found"
          exit 1
        fi

    - name: Use local calendar version wrapper script
      shell: bash
      run: |
        echo "ğŸ“¥ Using local calendar version wrapper script..."
        cp scripts/calendar-version-wrapper.js /tmp/calendar-version-wrapper.js
        chmod +x /tmp/calendar-version-wrapper.js

    - name: Run custom versioning
      id: custom-versioning
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        JIRA_BASE_URL: ${{ inputs.jira-base-url }}
        VERSION_PY_PATH: ${{ inputs.version-py-path }}
        VERSION_PREFIX: ${{ inputs.version-prefix }}
        DEFAULT_RELEASE_TYPE: ${{ inputs.default-release-type }}
        PATCH_VERSION_PREFIX: ${{ inputs.patch-version-prefix }}
        INCLUDE_PATCH_FOR_MINOR: ${{ inputs.include-patch-for-minor }}
      run: |        
        echo "ğŸš€ Running custom versioning..."
        node /tmp/calendar-version-wrapper.js

    - name: Commit and push version changes
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # ë³€ê²½ì‚¬í•­ í™•ì¸
        CHANGED_FILES=$(git diff --name-only)
        FILES_TO_COMMIT=""
        
        # ê´€ì‹¬ìˆëŠ” íŒŒì¼ë“¤ë§Œ í•„í„°ë§
        for file in package.json ${{ inputs.version-py-path }}; do
          if [ -f "$file" ] && echo "$CHANGED_FILES" | grep -q "^$file$"; then
            FILES_TO_COMMIT="$FILES_TO_COMMIT $file"
          fi
        done
        
        if [ -n "$FILES_TO_COMMIT" ]; then
          echo "ğŸ“ ë³€ê²½ëœ íŒŒì¼ë“¤ì„ ì»¤ë°‹í•©ë‹ˆë‹¤:$FILES_TO_COMMIT"
          
          # ë³€ê²½ëœ íŒŒì¼ë“¤ì„ ìŠ¤í…Œì´ì§•
          git add $FILES_TO_COMMIT
          
          # NEW_VERSION í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ì‚¬ìš©, ì•„ë‹ˆë©´ ê¸°ë³¸ ë©”ì‹œì§€
          if [ -n "$NEW_VERSION" ]; then
            COMMIT_MESSAGE="chore(release): $NEW_VERSION [skip ci]"
          else
            COMMIT_MESSAGE="chore: update version files [skip ci]"
          fi
          
          git commit -m "$COMMIT_MESSAGE"
          echo "âœ… Git ì»¤ë°‹ ì™„ë£Œ: $COMMIT_MESSAGE"
          
          # í‘¸ì‹œ ì¬ì‹œë„ ë¡œì§ ì¶”ê°€
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ”„ í‘¸ì‹œ ì‹œë„ $((RETRY_COUNT + 1))/$MAX_RETRIES"
            
            if git push origin HEAD; then
              echo "âœ… Git í‘¸ì‹œ ì™„ë£Œ"
              break
            else
              echo "âš ï¸ í‘¸ì‹œ ì‹¤íŒ¨, ì›ê²© ë³€ê²½ì‚¬í•­ í™•ì¸ ì¤‘..."
              RETRY_COUNT=$((RETRY_COUNT + 1))
              
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "ğŸ”„ ì›ê²© ë³€ê²½ì‚¬í•­ì„ ê°€ì ¸ì™€ì„œ rebase ì‹œë„..."
                git fetch origin
                
                # í˜„ì¬ ë¸Œëœì¹˜ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
                CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
                
                # rebase ì‹œë„
                if git rebase origin/$CURRENT_BRANCH; then
                  echo "âœ… Rebase ì„±ê³µ, ë‹¤ì‹œ í‘¸ì‹œ ì‹œë„"
                else
                  echo "âš ï¸ Rebase ì‹¤íŒ¨, ì¶©ëŒ í•´ê²° í•„ìš”"
                  git rebase --abort
                  
                  # ë§ˆì§€ë§‰ ì‹œë„ì¸ ê²½ìš° force push ì‚¬ìš© (ì‹ ì¤‘í•˜ê²Œ)
                  if [ $RETRY_COUNT -eq $((MAX_RETRIES - 1)) ]; then
                    echo "âš ï¸ ë§ˆì§€ë§‰ ì‹œë„: force push ì‚¬ìš© (ìœ„í—˜)"
                    git push origin HEAD --force-with-lease
                    echo "ğŸš¨ Force push ì™„ë£Œ (ì‹ ì¤‘í•˜ê²Œ ì‚¬ìš©ë¨)"
                    break
                  fi
                fi
              else
                echo "âŒ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼"
                exit 1
              fi
            fi
          done
        else
          echo "âšª ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
        fi

    - name: Create new version tag and release
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
      run: |
        if [ -n "$NEW_VERSION" ]; then
          echo "Creating new version tag: $NEW_VERSION"
          
          git tag "$NEW_VERSION"
          
          # íƒœê·¸ í‘¸ì‹œ ì¬ì‹œë„ ë¡œì§
          MAX_TAG_RETRIES=3
          TAG_RETRY_COUNT=0
          
          while [ $TAG_RETRY_COUNT -lt $MAX_TAG_RETRIES ]; do
            echo "ğŸ·ï¸ íƒœê·¸ í‘¸ì‹œ ì‹œë„ $((TAG_RETRY_COUNT + 1))/$MAX_TAG_RETRIES"
            
            if git push origin "$NEW_VERSION"; then
              echo "âœ… íƒœê·¸ í‘¸ì‹œ ì™„ë£Œ: $NEW_VERSION"
              break
            else
              echo "âš ï¸ íƒœê·¸ í‘¸ì‹œ ì‹¤íŒ¨"
              TAG_RETRY_COUNT=$((TAG_RETRY_COUNT + 1))
              
              if [ $TAG_RETRY_COUNT -lt $MAX_TAG_RETRIES ]; then
                echo "ğŸ”„ ì ê¹ ëŒ€ê¸° í›„ ì¬ì‹œë„..."
                sleep 2
              else
                echo "âŒ íƒœê·¸ í‘¸ì‹œ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼"
                # íƒœê·¸ í‘¸ì‹œ ì‹¤íŒ¨í•´ë„ ë¦´ë¦¬ì¦ˆëŠ” ê³„ì† ì§„í–‰
                echo "âš ï¸ íƒœê·¸ í‘¸ì‹œëŠ” ì‹¤íŒ¨í–ˆì§€ë§Œ ë¦´ë¦¬ì¦ˆ ìƒì„±ì€ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤."
              fi
            fi
          done
          
          if ! command -v gh &> /dev/null; then
            echo "Installing GitHub CLI..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh -y
          fi
          
          echo "Creating GitHub release with new version..."
          
          # Release notes íŒŒì¼ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€ ì‚¬ìš©
          if [ -f "RELEASE_NOTES.md" ]; then
            echo "Using generated release notes from RELEASE_NOTES.md"
            gh release create "$NEW_VERSION" --title "$NEW_VERSION" --notes-file "RELEASE_NOTES.md" --latest
          else
            echo "Using default release notes"
            RELEASE_NOTES="New Version Release $NEW_VERSION"
            gh release create "$NEW_VERSION" --title "$NEW_VERSION" --notes "$RELEASE_NOTES" --latest
          fi
          echo "GitHub release created: $NEW_VERSION"
        fi

branding:
  icon: 'tag'
  color: 'purple' 