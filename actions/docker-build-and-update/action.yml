name: 'Docker Build, Push and Update Repository'
description: 'Build Docker image, push to registry, and update another repository with new image tag'
author: 'GitHub Actions Workflows'

inputs:
  github-token:
    description: 'GitHub Personal Access Token with repo permissions'
    required: true
  node-version:
    description: 'Node.js version to use'
    required: false
    default: '18'
  docker-registry:
    description: 'Docker registry URL'
    required: true
  image-name:
    description: 'Docker ì´ë¯¸ì§€ ì´ë¦„'
    required: true
  image-tag:
    description: 'Docker ì´ë¯¸ì§€ íƒœê·¸ (ì˜ˆ: v1.0.0, 2025.01.15.1430)'
    required: true
  dockerfile-path:
    description: 'Dockerfile ê²½ë¡œ'
    required: false
    default: './Dockerfile'
  build-context:
    description: 'ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸'
    required: false
    default: '.'
  target-repo:
    description: 'ëŒ€ìƒ ë ˆí¬ì§€í† ë¦¬ (ì˜ˆ: owner/k8s-manifests)'
    required: true
  target-file-path:
    description: 'ì—…ë°ì´íŠ¸í•  íŒŒì¼ ê²½ë¡œ'
    required: true
  target-branch:
    description: 'ëŒ€ìƒ ë¸Œëœì¹˜ (ë¯¸ì§€ì •ì‹œ ê¸°ë³¸ ë¸Œëœì¹˜ ì‚¬ìš©)'
    required: false
    default: ''
  registry-username:
    description: 'Container Registry ì‚¬ìš©ìëª…'
    required: false
  registry-password:
    description: 'Container Registry íŒ¨ìŠ¤ì›Œë“œ'
    required: false
  commit-message:
    description: 'ì»¤ë°‹ ë©”ì‹œì§€'
    required: false
    default: ''
  teams-workflow-url:
    description: 'Microsoft Teams Workflow URL'
    required: false
    default: ''

outputs:
  image-tag:
    description: 'ìƒì„±ëœ ì´ë¯¸ì§€ íƒœê·¸'
    value: ${{ steps.docker-build-update.outputs.image-tag }}
  full-image-name:
    description: 'ì „ì²´ ì´ë¯¸ì§€ ì´ë¦„ (registry/image:tag)'
    value: ${{ steps.docker-build-update.outputs.full-image-name }}
  updated-file:
    description: 'ì—…ë°ì´íŠ¸ëœ íŒŒì¼ ê²½ë¡œ'
    value: ${{ steps.docker-build-update.outputs.updated-file }}
  commit-message:
    description: 'ì»¤ë°‹ ë©”ì‹œì§€'
    value: ${{ steps.docker-build-update.outputs.commit-message }}

runs:
  using: 'composite'
  steps:
    - name: Send Teams notification - Start
      if: ${{ inputs.teams-workflow-url != '' }}
      shell: bash
      run: |
        echo "ğŸ“¢ Teams ì•Œë¦¼ ì „ì†¡ ì¤‘: ë°°í¬ ì‹œì‘"
        
        TEAMS_WORKFLOW_URL="${{ inputs.teams-workflow-url }}"
        IMAGE_INFO="${{ inputs.image-name }}:${{ inputs.image-tag }}"
        REPO_INFO="${{ inputs.target-repo }}"
        
        # Teams Workflowìš© ë©”ì‹œì§€ JSON ìƒì„± (ë©˜ì…˜ ì§€ì›)
        cat > teams_message_start.json << EOF
        {
          "type": "message",
          "attachments": [
            {
              "contentType": "application/vnd.microsoft.card.adaptive",
              "content": {
                "$schema": "http://adaptivecards.json/schema/adaptive-card/1.5",
                "type": "AdaptiveCard",
                "msteams": {
                  "entities": [
                    {
                      "type": "mention",
                      "text": "<at>ì˜¤ë””ì˜¤ì—”ì§„</at>",
                      "mentioned": {
                          "id": "ZjdkZDQ4MmItYzU4ZC00MDViLWFlNjAtNTlmNmFjMzZmZWVmIyNjMDQzMWZmOC0zZTBkLTQ0ZjgtYmFlZS05YWFjMDQ1Nzk1NjMjI3RLUUEyYWI5RnQ=",
                          "name": "ì˜¤ë””ì˜¤ì—”ì§„",
                          "type": "tag"
                      }
                    }
                  ]
                },
                "body": [
                  {
                    "type": "TextBlock",
                    "text": "ğŸš€ Stage ë°°í¬ ì‹œì‘",
                    "size": "Large",
                    "weight": "Bolder"
                  },
                  {
                    "type": "TextBlock",
                    "text": "<at>ì˜¤ë””ì˜¤ì—”ì§„</at>",
                    "wrap": true
                  },
                  {
                    "type": "TextBlock",
                    "text": "Stage ë°°í¬ ì¤‘ì…ë‹ˆë‹¤.",
                    "wrap": true
                  },
                  {
                    "type": "TextBlock",
                    "text": "â³ ë°°í¬ ì§„í–‰ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”...",
                    "wrap": true
                  },
                  {
                    "type": "FactSet",
                    "facts": [
                      {
                        "title": "ì´ë¯¸ì§€:",
                        "value": "${IMAGE_INFO}"
                      },
                      {
                        "title": "ëŒ€ìƒ ë ˆí¬ì§€í† ë¦¬:",
                        "value": "${REPO_INFO}"
                      },
                      {
                        "title": "ìƒíƒœ:",
                        "value": "ì§„í–‰ ì¤‘ ğŸ”„"
                      }
                    ]
                  }
                ]
              }
            }
          ]
        }
        EOF
        
        # Teams Webhookìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
        curl -H "Content-Type: application/json" \
             -d @teams_message_start.json \
             "${TEAMS_WORKFLOW_URL}"
        
        echo "âœ… Teams ë°°í¬ ì‹œì‘ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ"

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Download docker build update script
      shell: bash
      run: |
        echo "ğŸ“¥ Downloading Docker build and update script..."
        curl -fsSL -o /tmp/docker-build-push-update.js https://raw.githubusercontent.com/akfmdl/github-actions-workflows/test/scripts/docker-build-push-update.js
        chmod +x /tmp/docker-build-push-update.js
        
    - name: Docker build, push and update repository
      id: docker-build-update
      shell: bash
      env:
        DOCKER_REGISTRY: ${{ inputs.docker-registry }}
        IMAGE_NAME: ${{ inputs.image-name }}
        IMAGE_TAG: ${{ inputs.image-tag }}
        DOCKERFILE_PATH: ${{ inputs.dockerfile-path }}
        BUILD_CONTEXT: ${{ inputs.build-context }}
        TARGET_REPO: ${{ inputs.target-repo }}
        TARGET_FILE_PATH: ${{ inputs.target-file-path }}
        TARGET_BRANCH: ${{ inputs.target-branch }}
        GITHUB_TOKEN: ${{ inputs.github-token }}
        REGISTRY_USERNAME: ${{ inputs.registry-username }}
        REGISTRY_PASSWORD: ${{ inputs.registry-password }}
        COMMIT_MESSAGE: ${{ inputs.commit-message }}
        SOURCE_REPOSITORY: ${{ github.repository }}
      run: |
        echo "ğŸš€ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ë ˆí¬ì§€í† ë¦¬ ì—…ë°ì´íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
        node /tmp/docker-build-push-update.js
        
    - name: Send Teams notification - Complete
      if: ${{ inputs.teams-workflow-url != '' }}
      shell: bash
      run: |
        echo "ğŸ“¢ Teams ì•Œë¦¼ ì „ì†¡ ì¤‘: ë°°í¬ ì™„ë£Œ"
        
        TEAMS_WORKFLOW_URL="${{ inputs.teams-workflow-url }}"
        IMAGE_INFO="${{ inputs.image-name }}:${{ steps.docker-build-update.outputs.image-tag }}"
        FULL_IMAGE="${{ steps.docker-build-update.outputs.full-image-name }}"
        REPO_INFO="${{ inputs.target-repo }}"
        UPDATED_FILE="${{ steps.docker-build-update.outputs.updated-file }}"
        TARGET_BRANCH="${{ inputs.target-branch }}"
        
        # ì„±ê³µ/ì‹¤íŒ¨ ìƒíƒœì— ë”°ë¥¸ ìƒ‰ìƒ ë° ë©”ì‹œì§€ ì„¤ì •
        if [ "${{ job.status }}" == "success" ]; then
          THEME_COLOR="28A745"
          STATUS_ICON="âœ…"
          STATUS_MESSAGE="Stage ë°°í¬ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤."
          ACTIVITY_TITLE="âœ… Stage ë°°í¬ ì™„ë£Œ"
        else
          THEME_COLOR="DC3545"
          STATUS_ICON="âŒ"
          STATUS_MESSAGE="Stage ë°°í¬ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          ACTIVITY_TITLE="âŒ Stage ë°°í¬ ì‹¤íŒ¨"
        fi
      
        
        # ë°°í¬ ì™„ë£Œ ë©”ì‹œì§€ JSON ìƒì„± (ë©˜ì…˜ ì§€ì›)
        cat > teams_message_complete.json << EOF
        {
          "type": "message",
          "attachments": [
            {
              "contentType": "application/vnd.microsoft.card.adaptive",
              "content": {
                "$schema": "http://adaptivecards.json/schema/adaptive-card/1.5",
                "type": "AdaptiveCard",
                "msteams": {
                  "entities": [
                    {
                        "type": "mention",
                        "text": "<at>ì˜¤ë””ì˜¤ì—”ì§„</at>",
                        "mentioned": {
                            "id": "ZjdkZDQ4MmItYzU4ZC00MDViLWFlNjAtNTlmNmFjMzZmZWVmIyNjMDQzMWZmOC0zZTBkLTQ0ZjgtYmFlZS05YWFjMDQ1Nzk1NjMjI3RLUUEyYWI5RnQ=",
                            "name": "ì˜¤ë””ì˜¤ì—”ì§„",
                            "type": "tag"
                        }
                    }
                  ]
                },
                "body": [
                  {
                    "type": "TextBlock",
                    "text": "${ACTIVITY_TITLE}",
                    "size": "Large",
                    "weight": "Bolder"
                  },
                  {
                    "type": "TextBlock",
                    "text": "<at>ì˜¤ë””ì˜¤ì—”ì§„</at>",
                    "wrap": true
                  },
                  {
                    "type": "TextBlock",
                    "text": "${STATUS_MESSAGE}",
                    "wrap": true
                  },
                  {
                    "type": "FactSet",
                    "facts": [
                      {
                        "title": "ì´ë¯¸ì§€:",
                        "value": "${IMAGE_INFO}"
                      },
                      {
                        "title": "ì „ì²´ ì´ë¯¸ì§€ëª…:",
                        "value": "${FULL_IMAGE}"
                      },
                      {
                        "title": "ëŒ€ìƒ ë ˆí¬ì§€í† ë¦¬:",
                        "value": "${REPO_INFO}"
                      },
                      {
                        "title": "ëŒ€ìƒ ë¸Œëœì¹˜:",
                        "value": "${TARGET_BRANCH:-default}"
                      },
                      {
                        "title": "ì—…ë°ì´íŠ¸ëœ íŒŒì¼:",
                        "value": "${UPDATED_FILE:-ì—†ìŒ}"
                      }
                    ]
                  }
                ],
                "actions": [
                  {
                    "type": "Action.OpenUrl",
                    "title": "GitHub Actions ë³´ê¸°",
                    "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            }
          ]
        }
        EOF
        
        # Teams Webhookìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
        curl -H "Content-Type: application/json" \
             -d @teams_message_complete.json \
             "${TEAMS_WORKFLOW_URL}"
        
        echo "âœ… Teams ë°°í¬ ì™„ë£Œ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ"

    - name: Workflow Complete
      shell: bash
      run: |
        echo "âœ… Docker Build and Update workflow completed successfully!"
        echo "ğŸ“Š Summary has been generated with detailed links and information."

branding:
  icon: 'package'
  color: 'blue' 